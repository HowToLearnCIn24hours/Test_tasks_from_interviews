/*There is a table user (user_id - user id, installed_at - installation date) and a client_session activity table (user_id, created_at - activity time stamp).
Write an SQL query that counts Retention 1, 3, 7 days for users with installations grouped by months (since January 2022). */

/*Retention: Number of users who used your product on a specific day รท Number of users who first used your product on Day 0 of your time period*/

Create table user_ (
user_id int primary key auto_increment,
installed_at date not null
);

Create table client_session (
user_id int,
created_at timestamp not null
);

INSERT INTO user_ (installed_at)
VALUES ('2022-01-01'),('2022-01-02'),('2022-02-01'),('2022-02-02'),('2022-03-01'),('2022-03-02'),
('2022-04-01'),('2022-04-02'),('2022-05-01'),('2022-05-02'),('2022-06-01'),('2022-06-02'),
('2022-07-01'),('2022-07-02'),('2022-08-01'),('2022-08-02'),('2022-09-01'),('2022-09-02'),
('2022-10-01'),('2022-10-02'),('2022-11-01'),('2022-11-02'),('2022-12-01'),('2022-12-02'), 
('2022-02-03'),('2022-03-03'),('2022-04-03'),('2022-05-03'),('2022-06-03'),('2022-07-03'),
('2022-02-04'),('2022-03-04'),('2022-04-05'),('2021-05-05'),('2021-05-06'),('2021-06-06'),
('2022-07-07'),('2022-05-07'),('2022-03-07'),('2022-02-07'),('2022-03-03'),('2022-09-03'),
('2022-05-11'),('2022-05-13'),('2022-06-13'),('2022-05-10'),('2022-07-10'),('2022-05-18');

INSERT INTO client_session (user_id, created_at)
VALUES (1,'2022-01-13 19:30:12'),(2,'2022-01-13 19:30:12'),(3,'2022-01-13 19:30:12'),(4,'2022-01-14 12:15:14'),(5, '2022-02-15 20:01:25'),
(6,'2022-02-16 03:15:34'),(7,'2022-02-16 03:15:34'),(8,'2022-02-16 03:15:34'),(9,'2022-02-17 14:15:16'),(10,'2022-02-18 23:05:50'),(11,'2022-02-18 23:05:50'),
(12,'2022-01-19 15:30:19'),(13,'2022-01-19 16:30:19'),(14,'2022-01-19 17:30:10'),(15,'2022-01-20 13:14:15'),(8,'2022-03-03 03:15:34'), 
(17,'2022-03-13 19:30:12'),(3,'2022-02-13 19:30:12'),(4,'2022-04-13 19:30:12'),(5,'2022-04-14 12:15:14'),(1, '2022-03-15 20:01:25'),
(21,'2022-05-16 03:15:34'),(23,'2022-03-16 03:15:34'),(25,'2022-05-16 03:15:34'),(46,'2022-04-17 14:15:16'),(13,'2022-06-08 23:05:50'),(1,'2022-05-18 23:05:50'),
(11,'2022-02-19 15:30:19'),(22,'2022-01-19 16:30:19'),(23,'2022-01-19 17:30:10'),(24,'2022-01-20 13:14:15'),(8,'2022-03-03 03:15:34'), 
(22,'2022-03-09 16:30:19'),(23,'2022-04-09 17:30:10'),(24,'2022-04-20 13:14:15'),(24,'2022-05-22 13:14:15'),(1,'2022-05-03 03:15:34'), (1,'2022-01-01 19:30:12'),(3,'2022-01-03 19:30:12'),(4,'2022-01-01 19:30:12'),(5,'2022-01-07 12:15:14'),(1, '2022-02-03 20:01:25'),
(3,'2022-02-07 03:15:34'),(7,'2022-02-01 03:15:34'),(8,'2022-02-03 03:15:34'),(1,'2022-02-07 14:15:16'),(9,'2022-02-03 23:05:50'),(10,'2022-02-07 23:05:50'),
(11,'2022-01-01 15:30:19'),(15,'2022-01-03 16:30:19'),(18,'2022-01-07 17:30:10'),(16,'2022-01-03 13:14:15'),(8,'2022-03-01 03:15:34'), 
(17,'2022-03-07 19:30:12'),(3,'2022-02-07 19:30:12'),(4,'2022-04-03 19:30:12'),(5,'2022-04-01 12:15:14'),(20, '2022-03-07 20:01:25'),
(13,'2022-05-03 03:15:34'),(17,'2022-03-01 03:15:34'),(18,'2022-05-07 03:15:34'),(11,'2022-04-01 14:15:16'),(19,'2022-06-03 23:05:50'),(10,'2022-05-07 23:05:50');

CREATE VIEW users_temp_4 AS
SELECT u.user_id, u.installed_at, c.created_at
FROM user_ u 
LEFT JOIN client_session c on u.user_id=c.user_id
Where c.created_at > u.installed_at;

CREATE VIEW user_act_temp_6 as
SELECT Month(installed_at) as Month,
count(user_id) users,
count(case when datediff(created_at,installed_at)=1 then  
user_id else null end) day_1,
count(case when datediff(created_at,installed_at)=2 then  
user_id else null end) day_3,
count(case when datediff(created_at,installed_at)=6 then  
user_id else null end) day_7
FROM users_temp_4
where year(created_at)>=2022
Group by Month(installed_at);

SELECT Month, users,
ROUND((day_1/users)*100,2) day_1,
ROUND((day_3/users)*100,2) day_3,
ROUND((day_7/users)*100,2) day_7
FROM user_act_temp_6;                